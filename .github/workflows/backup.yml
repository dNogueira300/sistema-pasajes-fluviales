name: Respaldo de Base de Datos Supabase a S3

on:
  workflow_dispatch:
  schedule:
    # Se ejecuta todos días a las 5:00 AM UTC
    # Se ejecuta todos días a las 12:00 AM GMT-5 (hora de Perú)
    - cron: "0 5 * * *"

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (Opcional, solo si necesitas algo del repo)
        uses: actions/checkout@v3

      - name: 1. Instalar el cliente de PostgreSQL 17 (pg_dump)

        run: |
          sudo apt-get update
          sudo apt-get install -y wget ca-certificates
          # Añadir el repositorio oficial de PostgreSQL
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          # Importar la llave del repositorio
          wget -qO- https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo tee /etc/apt/trusted.gpg.d/pgdg.asc > /dev/null
          # Actualizar e instalar el cliente v17
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17

      - name: 2. Configurar credenciales de AWS
        run: |
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # Opcional: define tu región de S3 si es necesario
          # aws configure set region tu-region-s3

      - name: 3. Definir nombre del archivo de respaldo
        run: |
          BACKUP_FILE="db_backup_$(date +'%Y-%m-%dT%H-%M-%S').sqlc"
          echo "BACKUP_FILE=${BACKUP_FILE}" >> $GITHUB_ENV
          # Define la ruta completa en S3
          echo "S3_PATH=s3://${{ secrets.S3_BUCKET_NAME }}/backups/${BACKUP_FILE}" >> $GITHUB_ENV

      - name: 4. Crear el respaldo de la base de datos
        env:
          PGPASSWORD: ${{ secrets.DB_SUPER_PASSWORD }}
          PGHOST: ${{ secrets.DB_HOST }}
          PGUSER: ${{ secrets.DB_USER }}
          PGDATABASE: ${{ secrets.DB_NAME }}
        run: |
          echo "Creando respaldo: ${{ env.BACKUP_FILE }}..."
          pg_dump \
            --format=c \
            --file="${{ env.BACKUP_FILE }}" \
            --host="$PGHOST" \
            --username="$PGUSER" \
            --dbname="$PGDATABASE"
        # run: |
        #   pg_dump \
        #     --format=c \
        #     --file="${{ env.BACKUP_FILE }}" \
        #     "${{ secrets.DB_CONNECTION_STRING }}"

      - name: 5. Subir el respaldo a S3
        run: |
          echo "Subiendo respaldo a ${{ env.S3_PATH }}..."
          aws s3 cp "${{ env.BACKUP_FILE }}" "${{ env.S3_PATH }}"
          echo "Subida completada."

      - name: 6. Limpiar el archivo local (opcional)
        run: |
          rm "${{ env.BACKUP_FILE }}"
          echo "Archivo local eliminado."
